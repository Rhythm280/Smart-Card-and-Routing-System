package com.smartBusSystem.dao;

import com.smartBusSystem.model.Trip;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class TripDAO {

    private Connection conn;

    public TripDAO(Connection conn) {
        this.conn = conn;
    }

    /**
     * Record a new trip in DB
     */
    public void recordTrip(int passengerId, int srcStopId, int dstStopId, double routeDistanceKm, double fareCharged) throws SQLException {
        String sql = "INSERT INTO trip (passenger_id, src_stop_id, dst_stop_id, route_distance_km, fare_charged, created_at) " +
                     "VALUES (?, ?, ?, ?, ?, NOW())";

        try (PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, passengerId);
            ps.setInt(2, srcStopId);
            ps.setInt(3, dstStopId);
            ps.setDouble(4, routeDistanceKm);
            ps.setDouble(5, fareCharged);

            ps.executeUpdate();
        }
    }

    /**
     * Fetch all trips for a given passenger (Trip History)
     */
    public List<Trip> getTripsByPassenger(int passengerId) throws SQLException {
        List<Trip> trips = new ArrayList<>();
        String sql = "SELECT trip_id, passenger_id, src_stop_id, dst_stop_id, route_distance_km, fare_charged, created_at " +
                     "FROM trip WHERE passenger_id = ? ORDER BY created_at DESC";

        try (PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setInt(1, passengerId);
            try (ResultSet rs = ps.executeQuery()) {
                while (rs.next()) {
                    Trip trip = new Trip(rs.getInt("trip_id"), rs.getInt("passenger_id"),rs.getInt("src_stop_id"), rs.getInt("dst_stop_id"), rs.getDouble("route_distance_km"), rs.getDouble("fare_charged"), rs.getTimestamp("created_at"));
                    trips.add(trip);
                }
            }
        }
        return trips;
    }
}
